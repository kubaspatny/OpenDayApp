<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="#{localeBean.language}"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">
<f:view locale="#{localeBean.locale}">
    <h:head>

        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>

        <title>Open Days</title>

        <h:outputScript library="primefaces" name="jquery/jquery.js" target="head"/>
        <h:outputScript target="head">
            $ = jQuery;
        </h:outputScript>

        <h:outputScript name="js/bootstrap.js"/>
        <h:outputScript name="js/primefaces-calendar.js"/>
        <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700,900' rel='stylesheet' type='text/css'/>

    </h:head>

    <f:metadata>
        <f:viewParam name="id" value="#{eventBean.eventId}" />
        <f:event type="preRenderView" listener="#{eventBean.init}" />
    </f:metadata>

    <h:body>
        <h:outputStylesheet name="css/bootstrap.css" />
        <h:outputStylesheet name="css/logo.css" />
        <h:outputStylesheet name="css/main.css" />

        <!-- DIALOGS -->
        <p:dialog header="Add person to this event" widgetVar="add-person-dlg" resizable="false" draggable="false" modal="true">
            <h:form id="add-person-form" styleClass="form-table">

                <h:panelGrid id="panel" columns="3">

                    <p:outputLabel for="email" value="NAME" styleClass="sr-only"/>
                    <p:inputText id="email" value="#{eventBean.newPersonEmail}" placeholder="Email" styleClass="form-control" required="true" requiredMessage="FILL IN EMAIL">
                        <f:validator binding="#{emailFormatValidator}"/>
                        <p:ajax update="errorEmail @form:submit" event="keyup"/>
                    </p:inputText>

                    <h:panelGroup layout="block" id="errorEmail">
                        <h:panelGroup layout="block" styleClass="alert alert-success dialog-alert" rendered="#{eventBean.isRegistered(eventBean.newPersonEmail)}">
                            <span class="glyphicon glyphicon-ok margin-right-10"/>
                            <h:outputText value="User is registered"/>
                        </h:panelGroup>

                        <h:panelGroup layout="block" styleClass="alert alert-warning dialog-alert" rendered="#{not empty eventBean.newPersonEmail and not eventBean.isRegistered(eventBean.newPersonEmail)}">
                            <span class="glyphicon glyphicon-flag margin-right-10"/>
                            <h:outputText value="User will be registered"/>
                        </h:panelGroup>
                        <p:message for="email" id="msgEmail" display="text"/>

                    </h:panelGroup>

                </h:panelGrid>
                <p:commandButton id="submit" value="#{not empty eventBean.newPersonEmail and not eventBean.isRegistered(eventBean.newPersonEmail) ? 'Register and add user' : 'Add user'}" styleClass="margin-top-10" update="@form"
                                 action="#{eventBean.addNewPersonToEmailList}"
                                 oncomplete="if (args &amp;&amp; !args.validationFailed &amp;&amp; !args.errorCreatingEvent) PF('add-person-dlg').hide()">
                    <f:param name="id" value="#{eventBean.eventId}" />
                </p:commandButton>

                <h:panelGroup layout="block" styleClass="alert alert-danger margin-top-10" rendered="#{createEventBean.errorCreatingEvent}">
                    <h:outputText value="ERROR CREATING EVENT"/>
                </h:panelGroup>
            </h:form>
        </p:dialog>

        <p:dialog id="file-upload-dialog" header="Upload file with emails" widgetVar="file-upload-dlg" resizable="false" draggable="false" modal="true">
            <h:form id="file-upload-form" styleClass="form-table" enctype="multipart/form-data" rendered="#{empty CSVFileUploadBean.emails}">
                <h:panelGrid id="file-upload-panel" columns="1">

                    <p:fileUpload value="#{CSVFileUploadBean.file}"
                                  mode="advanced"
                                  skinSimple="true"
                                  allowTypes="/(\.|\/)(txt|csv)$/"
                                  sizeLimit="100000"
                                  fileUploadListener="#{CSVFileUploadBean.upload}"
                                  update="@form :file-upload-dialog :file-add-emails-form"
                                  required="true"
                                  oncomplete="PF('file-upload-dlg').show()">
                        <f:param name="id" value="#{eventBean.eventId}" />
                    </p:fileUpload>

                    <h:panelGroup layout="block" styleClass="alert alert-danger dialog-alert" rendered="#{CSVFileUploadBean.uploadedEmptyFile}">
                        <span class="glyphicon glyphicon-remove margin-right-10"/>
                        <h:outputText value="File doesn't contain any valid emails. [do i18n!]"/>
                    </h:panelGroup>

                </h:panelGrid>

            </h:form>

            <h:form id="file-add-emails-form" styleClass="form-table" rendered="#{not empty CSVFileUploadBean.emails}">

                <h:dataTable value="#{CSVFileUploadBean.emails}" var="e" styleClass="no-header" style="line-height: 28px">

                    <p:column styleClass="event-date">
                        <h:outputText value="#{e}" />
                    </p:column>

                    <p:column>
                        <h:panelGroup layout="block" styleClass="alert alert-success dialog-alert-smaller margin-left-20" rendered="#{eventBean.isRegistered(e)}">
                            <span class="glyphicon glyphicon-ok margin-right-10"/>
                            <h:outputText value="User is registered"/>
                        </h:panelGroup>

                        <h:panelGroup layout="block" styleClass="alert alert-warning dialog-alert-smaller margin-left-20" rendered="#{not eventBean.isRegistered(e)}">
                            <span class="glyphicon glyphicon-flag margin-right-10"/>
                            <h:outputText value="User will be registered"/>
                        </h:panelGroup>
                    </p:column>

                    <p:column>
                        <div class="right padding-left-20">
                            <p:commandButton ajax="true" styleClass="material-button-image image-button-delete ui-button-icon-only no-select"
                                             actionListener="#{CSVFileUploadBean.removeEmail(e)}" value=""
                                             update="@form :file-upload-dialog :file-add-emails-form"
                                             oncomplete="PF('file-upload-dlg').show()">
                                <f:param name="id" value="#{eventBean.eventId}"/>
                            </p:commandButton>
                        </div>
                    </p:column>

                </h:dataTable>

                <p:commandButton id="submit-file" value="#{eventBean.areAllEmailsRegistered(CSVFileUploadBean.emails) ? 'Add emails [i18n]' : 'Register and add emails [i18n]'}" styleClass="margin-top-10" update="@form"
                                 oncomplete="if (args &amp;&amp; !args.validationFailed &amp;&amp; !args.errorCreatingEvent &amp;&amp; args.uploadFinished) PF('file-upload-dlg').hide()"
                                 action="#{eventBean.addEmailsToEmailList(CSVFileUploadBean.emails)}">
                    <f:param name="id" value="#{eventBean.eventId}" />
                </p:commandButton>
            </h:form>
        </p:dialog>

        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
            <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
            <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
        </p:confirmDialog>

        <nav class="navbar navbar-inverse navbar-fixed-top">
            <div class="container-fluid">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <h:link styleClass="navbar-brand logo-navbar" outcome="index">OPEN DAYS</h:link>
                </div>

                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav navbar-right">
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><h:outputText value="#{userBB.name}"/><span class="caret"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="#">Profile</a></li>
                                <li><a href="#">Settings</a></li>
                                <li class="divider"></li>
                                <li><h:outputLink value="#{root}/logout">Sign out</h:outputLink></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <h:panelGroup styleClass="container" layout="block">

            <!-- VIEW MODE -->
            <!-- SIDE PANEL WITH TABS+VIEWS -->
            <h:panelGroup styleClass="row" layout="block" rendered="#{param.id != null}">

                <div class="col-md-2 no-padding">

                    <ul class="nav nav-tabs side-nav" data-tabs="tabs">
                        <li class="active">
                            <a data-toggle="tab" href="#information">
                                <h:graphicImage value="#{resource['images/edit18.png']}"/>
                                <span>Information</span>
                            </a>
                        </li>
                        <li>
                            <a data-toggle="tab" href="#routes">
                                <h:graphicImage value="#{resource['images/delete18.png']}"/>
                                <span>Routes</span>
                            </a>
                        </li>
                        <li>
                            <a data-toggle="tab" href="#people">
                                <h:graphicImage value="#{resource['images/edit18.png']}"/>
                                <span>People</span>
                            </a>
                        </li>
                        <li>
                            <a data-toggle="tab" href="#statistics">
                                <h:graphicImage value="#{resource['images/delete18.png']}"/>
                                <span>Statistics</span>
                            </a>
                        </li>
                        <li>
                            <a data-toggle="tab" href="#live">
                                <h:graphicImage value="#{resource['images/edit18.png']}"/>
                                <span>Live</span>
                            </a>
                        </li>
                    </ul>

                </div>

                <div class="col-md-10 top-padding">

                    <div class="tab-content">
                        <div class="tab-pane active" id="information">

                            <div class="material-container">

                                <div class="box-toolbar">
                                    <span class="left title"><h:outputText value="#{eventBean.event.name}"/></span>
                                </div>

                                <div class="box-content">

                                    <h:outputText styleClass="font500" value="Information:"/><br/>
                                    <h:outputText styleClass="font300" value="#{eventBean.event.information}"/>
                                    <h:outputText styleClass="font300 italic" value="No information added yet." rendered="#{empty eventBean.event.information}"/><br/><br/>

                                    <h:outputText styleClass="font500" value="Date:"/><br/>
                                    <h:outputText styleClass="font300" value="#{eventBean.event.date.toString('dd/MM/yyyy')}" /><br/><br/>

                                    <h:outputText styleClass="font500" value="Organizer:"/><br/>
                                    <h:outputText styleClass="font300" value="#{eventBean.event.organizer.username}" /><br/><br/>

                                </div>
                            </div>
                            
                        </div>
                        <div class="tab-pane" id="routes">
                            <div class="material-container">

                                <div class="box-toolbar">
                                    <span class="left title"><h:outputText value="ROUTES"/></span>
                                    <h:link styleClass="right material-button-flat no-select" value="NEW" outcome="route">
                                        <f:param name="mode" value="create"/>
                                        <f:param name="eventId" value="#{eventBean.eventId}"/>
                                    </h:link>
                                </div>

                                <div class="box-content">

                                    <h:form id="routes-form">
                                        <p:dataTable var="route" value="#{eventBean.event.routes}" rendered="#{not empty eventBean.event.routes}" styleClass="no-header">

                                            <p:column styleClass="event-date" style="width: 40px;">
                                                <h:panelGroup layout="block" styleClass="circle" style="background-color: #{route.hexColor};"/>
                                            </p:column>

                                            <p:column styleClass="event-date">
                                                <h:link styleClass="event-name" value="#{route.name}" outcome="route">
                                                    <f:param name="mode" value="view"/>
                                                    <f:param name="eventId" value="#{eventBean.eventId}"/>
                                                    <f:param name="routeId" value="#{route.id}"/>
                                                </h:link>
                                            </p:column>

                                            <p:column styleClass="event-date">
                                                <h:outputText value="#{route.date.toString('HH:mm')}" />
                                            </p:column>

                                            <p:column>
                                                <div class="right">
                                                    <p:commandButton styleClass="material-button-image image-button-delete ui-button-icon-only no-select"
                                                                     actionListener="#{eventBean.removeRoute(route.id)}" value="" update="@form">
                                                        <p:confirm header="Confirmation" message="Do you really want to delete this route?" icon="icon-empty"/>
                                                        <f:param name="id" value="#{eventBean.eventId}"/>
                                                    </p:commandButton>
                                                </div>
                                            </p:column>

                                        </p:dataTable>

                                        <h:panelGroup layout="block" styleClass="alert alert-info" rendered="#{empty eventBean.event.routes}" >
                                            <h:outputText value="No routes added yet."/>
                                        </h:panelGroup>

                                    </h:form>

                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="people">
                            <div class="material-container">

                                <div class="box-toolbar">
                                    <span class="left title"><h:outputText value="PEOPLE"/></span>
                                    <h:form>
                                        <h:outputLink class="right material-button-flat no-select" value="javascript:void(0)" onclick="PF('add-person-dlg').show();">NEW</h:outputLink>
                                        <h:outputLink class="right material-button-flat no-select" value="javascript:void(0)" onclick="PF('file-upload-dlg').show();">UPLOAD</h:outputLink>
                                    </h:form>
                                </div>

                                <div class="box-content">

                                    <h:form id="people-form">
                                        <p:dataTable var="person" value="#{eventBean.event.emailList}" rendered="#{not empty eventBean.event.emailList}" styleClass="no-header">

                                            <p:column styleClass="event-date">
                                                <h:outputText value="#{person}" />
                                            </p:column>

                                            <p:column>
                                                <div class="right">
                                                    <p:commandButton styleClass="material-button-image image-button-delete ui-button-icon-only no-select"
                                                                     actionListener="#{eventBean.removePersonFromEmailList(person)}" value="" update="@form">
                                                        <p:confirm header="Confirmation" message="Do you really want to delete this email?" icon="icon-empty"/>
                                                        <f:param name="id" value="#{eventBean.eventId}"/>
                                                    </p:commandButton>
                                                </div>
                                            </p:column>

                                        </p:dataTable>

                                        <h:panelGroup layout="block" styleClass="alert alert-info" rendered="#{empty eventBean.event.emailList}" >
                                            <h:outputText value="No people added yet."/>
                                        </h:panelGroup>

                                    </h:form>

                                </div>

                            </div>
                        </div>
                        <div class="tab-pane" id="statistics">
                            <div class="material-container">

                                <div class="box-toolbar">
                                    <span class="left title"><h:outputText value="STATS"/></span>
                                </div>

                                <div class="box-content">
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="live">
                            <div class="material-container" style="background-color: rgba(0, 124, 10, 0.65);">

                                <div class="box-toolbar">
                                    <span class="left title"><h:outputText value="LIVE"/></span>
                                </div>

                                <div class="box-content">
                                    <h:form id="live-form">
                                        <h1><h:outputText value="#{demoBB.text}"/></h1>
                                        <p:poll interval="1" listener="#{demoBB.update()}" update="@form">
                                            <f:param name="id" value="#{eventBean.eventId}" />
                                        </p:poll>
                                    </h:form>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

            </h:panelGroup>

        </h:panelGroup>

    </h:body>
</f:view>
</html>